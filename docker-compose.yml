# llama.cpp + OpenCode Manager + OpenClaw + Mission Control 部署配置
# 基于 Jenkins Pipeline: pipeline-llamacpp-opencode-h200-mig71g.groovy
# 服务端口:
#   - llama.cpp: 8080
#   - OpenCode Manager: 5003
#   - OpenCode Server: 5551
#   - OpenClaw Gateway: 18789
#   - Mission Control: 3000

services:
  runnode-llamacpp-opencode:
    image: ${REGISTRY_SOURCE:-registry.cn-shenzhen.aliyuncs.com}/${IMAGE_REPO_MAIN:-sailfish/runnode-llamacpp-glm47-opencode}:${IMAGE_TAG_MAIN:-latest}
    container_name: runnode-llamacpp-opencode
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile
    # Requires NVIDIA Container Toolkit on the host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    ports:
      # llama.cpp
      - "${PORT_LLAMA:-8080}:8080"
      # OpenCode Manager
      - "${PORT_OPENCODE_MGR:-5003}:5003"
      # OpenCode Server
      - "${PORT_OPENCODE:-5551}:5551"
      # OpenClaw Gateway
      - "${PORT_OPENCLAW_GATEWAY:-18789}:18789"
      # Mission Control
      - "${PORT_OPENCLAW_MC:-3000}:3000"

    volumes:
      # 模型挂载
      - ${MODEL_MOUNT_PATH:-/data/sailfish/vllm-ollama/ollama_data/models}:/models
      # Workspace 挂载
      - ${WORKSPACE_MOUNT_PATH:-/data/sailfish/vllm-ollama/workspace}/${HELM_RELEASE_NAME:-runnode}:/workspace
      # OpenClaw 配置挂载（注释掉，让 start.sh 生成配置）
      # - ${OPENCLAW_MOUNT_PATH:-/data/sailfish/vllm-ollama/openclaw-config}/${HELM_RELEASE_NAME:-runnode}:/root/.openclaw

    environment:
      # ========== 基础环境 ==========
      TZ: ${TZ:-Asia/Shanghai}
      NODE_ENV: ${NODE_ENV:-production}

      # ========== 代理配置 ==========
      http_proxy: ${HTTP_PROXY_URL:-}
      https_proxy: ${HTTP_PROXY_URL:-}
      HTTP_PROXY: ${HTTP_PROXY_URL:-}
      HTTPS_PROXY: ${HTTP_PROXY_URL:-}
      no_proxy: ${NO_PROXY_LIST:-bytepiping-storage.bytebroad.com,bytepiping-storage.bytebroad.com.cn,localhost,127.0.0.1,::1,.svc,.svc.cluster.local,169.254.169.254}
      NO_PROXY: ${NO_PROXY_LIST:-bytepiping-storage.bytebroad.com,bytepiping-storage.bytebroad.com.cn,localhost,127.0.0.1,::1,.svc,.svc.cluster.local,169.254.169.254}

      # ========== 模型选择 ==========
      # 支持：glm5 / glm47flash / minimax25 / kimi25
      MODEL_PRESET: ${MODEL_PRESET:-glm47flash}
      GPU_PROFILE: ${GPU_PROFILE:-35g}

      # 模型路径（根据 MODEL_PRESET 选择对应的路径）
      MODEL_PATH_GLM5: ${MODEL_PATH_GLM5:-}
      MODEL_PATH_GLM47FLASH: ${MODEL_PATH_GLM47FLASH:-/models/downloads/glm47flash/GLM-4.7-Flash-Q4_K_M.gguf}
      MODEL_PATH_MINIMAX25: ${MODEL_PATH_MINIMAX25:-}
      MODEL_PATH_KIMI25: ${MODEL_PATH_KIMI25:-}

      # ========== 模型自动下载 ==========
      MODEL_AUTO_DOWNLOAD: ${MODEL_AUTO_DOWNLOAD:-true}
      AUTO_DOWNLOAD_GLM47FLASH: ${AUTO_DOWNLOAD_GLM47FLASH:-true}
      MODEL_DOWNLOAD_URL: ${MODEL_DOWNLOAD_URL:-https://modelscope.cn/models/unsloth/GLM-4.7-Flash-GGUF/resolve/master/GLM-4.7-Flash-UD-TQ1_0.gguf}
      MODEL_DOWNLOAD_URLS: ${MODEL_DOWNLOAD_URLS:-}
      MODEL_DOWNLOAD_TOKEN: ${MODEL_DOWNLOAD_TOKEN:-}
      HF_TOKEN: ${HF_TOKEN:-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}
      GLM47FLASH_DOWNLOAD_URL: ${GLM47FLASH_DOWNLOAD_URL:-}
      GLM47FLASH_DOWNLOAD_TOKEN: ${GLM47FLASH_DOWNLOAD_TOKEN:-}

      # ========== llama.cpp 参数 ==========
      LLAMACPP_HOST: ${LLAMACPP_HOST:-0.0.0.0}
      LLAMACPP_PORT: ${LLAMACPP_PORT:-8080}
      LLAMACPP_CTX_SIZE: ${LLAMACPP_CTX_SIZE:-8192}
      LLAMACPP_N_GPU_LAYERS: ${LLAMACPP_N_GPU_LAYERS:-35}
      LLAMACPP_THREADS: ${LLAMACPP_THREADS:-8}
      LLAMACPP_PARALLEL: ${LLAMACPP_PARALLEL:-1}
      LLAMACPP_EXTRA_ARGS: ${LLAMACPP_EXTRA_ARGS:---cache-type-k q8_0 --cache-type-v q8_0}

      # ========== OpenCode Manager 参数 ==========
      OPENCODE_HOST: ${OPENCODE_HOST:-127.0.0.1}
      OPENCODE_SERVER_PORT: ${OPENCODE_SERVER_PORT:-5551}
      OPENCODE_MANAGER_HOST: ${OPENCODE_MANAGER_HOST:-0.0.0.0}
      OPENCODE_MANAGER_PORT: ${OPENCODE_MANAGER_PORT:-5003}
      WORKSPACE_PATH: ${WORKSPACE_PATH:-/workspace}
      DATABASE_PATH: ${DATABASE_PATH:-/workspace/opencode-manager/data/opencode.db}
      AUTH_SECRET: ${AUTH_SECRET:-h7ZD0gcRspozjf7sSLeeyEtupKn8lD8MxJayV2Pf754=}
      AUTH_TRUSTED_ORIGINS: ${AUTH_TRUSTED_ORIGINS:-http://0.0.0.0:5003}
      AUTH_SECURE_COOKIES: ${AUTH_SECURE_COOKIES:-false}

      # OpenCode Manager: 健康检查和安装超时
      OPENCODE_HEALTH_TIMEOUT_MS: ${OPENCODE_HEALTH_TIMEOUT_MS:-120000}
      OPENCODE_UPGRADE_TIMEOUT_MS: ${OPENCODE_UPGRADE_TIMEOUT_MS:-600000}

      # ========== OpenClaw 参数 ==========
      OPENCLAW_GATEWAY_PORT: ${OPENCLAW_GATEWAY_PORT:-18789}
      OPENCLAW_GATEWAY_HOST: ${OPENCLAW_GATEWAY_HOST:-0.0.0.0}
      OPENCLAW_GATEWAY_PASSWORD: ${OPENCLAW_GATEWAY_PASSWORD:-sailfish020}
      OPENCLAW_MISSION_CONTROL_PORT: ${OPENCLAW_MISSION_CONTROL_PORT:-3000}
      OPENCLAW_STARTUP_TIMEOUT_SEC: ${OPENCLAW_STARTUP_TIMEOUT_SEC:-60}
      OPENCLAW_MISSION_CONTROL_STARTUP_TIMEOUT_SEC: ${OPENCLAW_MISSION_CONTROL_STARTUP_TIMEOUT_SEC:-60}

      # ========== 钉钉配置 ==========
      DINGTALK_CLIENT_ID: ${DINGTALK_CLIENT_ID:-ding4iqz6zneluw2gyts}
      DINGTALK_CLIENT_SECRET: ${DINGTALK_CLIENT_SECRET:-0eUE-rEvcQC1-vyW5e4vxvQDovEH0SHByNGH0vsy1SGirfjwNWG-9VsiPV0mlBrz}
      DINGTALK_ALLOWED_USERS: ${DINGTALK_ALLOWED_USERS:-*}

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
