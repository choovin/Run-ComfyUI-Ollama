---
name: push-runnode-jenkins
description: Complete CI/CD workflow for Run-ComfyUI-Ollama - update knowledge, commit, tag, push, monitor GitHub Actions, update Jenkins job config, and trigger deployment
version: 1.0.0
source: local-git-analysis
---

# Run-ComfyUI-Ollama CI/CD Workflow

Complete end-to-end deployment workflow that integrates GitHub Actions for image building with Jenkins for production deployment.

## Overview

This skill automates the full deployment pipeline:
1. **Knowledge Update** - Update documentation/knowledge base
2. **Git Operations** - Commit, tag, and push to remote
3. **GitHub Actions** - Monitor Docker image build
4. **Jenkins Update** - Update job configuration with new image tag
5. **Deployment** - Trigger and monitor production deployment

## Prerequisites

### Required Credentials

| Service | File Location | Usage |
|---------|--------------|-------|
| GitHub PAT | `jenkins-deploy/github-token-PAT.md` | GitHub API access |
| Jenkins | `jenkins-deploy/jenkins-accesstoken.md` | Jenkins API access |

### Environment Variables
- `GH_TOKEN` - GitHub Personal Access Token
- Jenkins credentials (user:token format)

## Workflow Steps

### Step 1: Update Knowledge Base

```bash
# Update knowledge documentation if needed
# Files are typically in knowledge/ directory
git status
```

### Step 2: Commit Changes

```bash
# Stage changes
git add -A

# Commit with conventional commit message
git commit -m "$(cat <<'EOF'
<type>(<scope>): <description>

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
EOF
)"
```

### Step 3: Create and Push Tag

**IMPORTANT**: Use the standard tag format for this project:

```
v<YYYYMMDD>-llamacpp-opencode-openclaw-r<release>-llamacpp-opencode-<version>-manager-<ref>
```

**Example Tags:**
- `v20260222-llamacpp-opencode-openclaw-r3-llamacpp-opencode-1.2.10-manager-main`
- `v20260227-llamacpp-opencode-openclaw-r4-llamacpp-opencode-1.2.10-manager-main`

**Tag Components:**
| Component | Description | Example |
|-----------|-------------|---------|
| `v<YYYYMMDD>` | Version with date | `v20260227` |
| `llamacpp-opencode-openclaw` | Fixed prefix | - |
| `r<release>` | Release number (increment) | `r3`, `r4` |
| `llamacpp-opencode-<version>` | OpenCode version | `llamacpp-opencode-1.2.10` |
| `manager-<ref>` | Manager reference | `manager-main` |

```bash
# Create tag with standard format
# Format: v<DATE>-llamacpp-opencode-openclaw-r<N>-llamacpp-opencode-<VERSION>-manager-<REF>
TAG="v$(date +%Y%m%d)-llamacpp-opencode-openclaw-r4-llamacpp-opencode-1.2.10-manager-main"
git tag "$TAG"

# Push commit and tags
git push origin main
git push origin --tags
```

**Note**: Increment the release number (r3 â†’ r4) for each new deployment.

### Step 4: Monitor GitHub Actions Build

Using `gh` CLI or curl:

```bash
# Using gh CLI
GH_TOKEN="<token>" gh run list --repo choovin/Run-ComfyUI-Ollama --limit 5

# Or using curl with API
curl -H "Authorization: token <token>" \
  "https://api.github.com/repos/choovin/Run-ComfyUI-Ollama/actions/runs?per_page=5"
```

#### Image Tag Format

GitHub Actions generates image tags in this format:
```
<YYYYMMDD>-<short-sha>-llamacpp-opencode-<version>-manager-<ref>
```

Example: `20260227-4c01af9-llamacpp-opencode--manager-`

**Note**: The git tag format differs from the Docker image tag format:
- **Git Tag**: `v20260222-llamacpp-opencode-openclaw-r3-llamacpp-opencode-1.2.10-manager-main`
- **Docker Image Tag**: `20260227-4c01af9-llamacpp-opencode--manager-` (auto-generated by GitHub Actions)

Check `.github/workflows/docker-acr.yml` for exact tag generation logic.

### Step 5: Verify Image in ACR

```bash
# Login to Alibaba Cloud Container Registry
echo '<password>' | docker login --username <username> --password-stdin registry.cn-shenzhen.aliyuncs.com

# Verify image exists
docker manifest inspect "registry.cn-shenzhen.aliyuncs.com/sailfish/runnode-llamacpp-glm47-opencode:<IMAGE_TAG>"
```

### Step 6: Update Jenkins Job Configuration

Use Jenkins CLI for reliability (REST API has sandbox restrictions):

```bash
# Download Jenkins CLI
curl -u "user:token" -o jenkins-cli.jar \
  "https://jenkins.bytebroad.com/jnlpJars/jenkins-cli.jar"

# Get current job config
java -jar jenkins-cli.jar -s "https://jenkins.bytebroad.com/" \
  -auth "user:token" -http \
  get-job "comfyui-nn-h200-136-141g-1" > config.xml

# Update IMAGE_TAG_MAIN in config
sed -i "s|IMAGE_TAG_MAIN.*=.*|IMAGE_TAG_MAIN = '<NEW_TAG>'|" config.xml

# Update job config
java -jar jenkins-cli.jar -s "https://jenkins.bytebroad.com/" \
  -auth "user:token" -http \
  update-job "comfyui-nn-h200-136-141g-1" < config.xml
```

### Step 7: Trigger Jenkins Build

```bash
# Trigger build
java -jar jenkins-cli.jar -s "https://jenkins.bytebroad.com/" \
  -auth "user:token" -http \
  build "comfyui-nn-h200-136-141g-1"

# Or using REST API
curl -u "user:token" -H "Jenkins-Crumb:<crumb>" \
  -X POST "https://jenkins.bytebroad.com/job/comfyui-nn-h200-136-141g-1/build"
```

### Step 8: Monitor Build and View Logs

```bash
# Check build status
curl -u "user:token" \
  "https://jenkins.bytebroad.com/job/comfyui-nn-h200-136-141g-1/api/json?tree=builds[number,result,timestamp,duration,building]"

# View build console output
curl -u "user:token" \
  "https://jenkins.bytebroad.com/job/comfyui-nn-h200-136-141g-1/lastBuild/consoleText"
```

## Jenkins Job Configuration

### Key Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `IMAGE_TAG_MAIN` | Docker image tag | `20260227-4c01af9-llamacpp-opencode--manager-` |
| `REGISTRY_SOURCE` | Source registry | `registry.cn-shenzhen.aliyuncs.com` |
| `REGISTRY_TARGET` | Target registry | `harbor.internal.quchiai.com` |
| `MODEL_PRESET` | Model configuration | `minimax25` |
| `HELM_RELEASE_NAME` | Kubernetes release | `nn-h200-136-141g-1` |
| `HELM_NAMESPACE` | Kubernetes namespace | `comfyui` |

### Service Endpoints

| Service | Internal Port | External URL |
|---------|--------------|-------------|
| llama.cpp | 8080 | `comfyui-nn-h200-136-141g-1.bytebroad.com` |
| OpenCode Manager | 5003 | `comfyui-nn-h200-136-141g-1-opm.bytebroad.com` |
| OpenCode Server | 5551 | `comfyui-nn-h200-136-141g-1-op.bytebroad.com` |
| OpenClaw Gateway | 18789 | `comfyui-nn-h200-136-141g-1-openclaw-gw.bytebroad.com` |
| Mission Control | 3000 | `comfyui-nn-h200-136-141g-1-openclaw-mc.bytebroad.com` |

## Troubleshooting

### GitHub API Network Issues

If GitHub API is unreachable, use alternative methods:
- Check GitHub Actions web UI directly
- Use `gh` CLI with proper authentication
- Check local git status for commit SHA

### Jenkins REST API 500 Error

If REST API returns 500 when updating config:
- **Cause**: Script Security sandbox restrictions
- **Solution**: Use Jenkins CLI with `-http` flag instead

```bash
java -jar jenkins-cli.jar -s "https://jenkins.bytebroad.com/" \
  -auth "user:token" -http \
  update-job "job-name" < config.xml
```

### Image Not Found in Registry

1. Verify GitHub Actions build completed successfully
2. Check image tag format matches workflow configuration
3. Ensure registry credentials are correct

## Quick Reference Commands

```bash
# Full workflow in one command sequence
git add -A && \
git commit -m "chore: update" && \
git push origin main && \
# Wait for GitHub Actions, then:
java -jar jenkins-cli.jar -s "https://jenkins.bytebroad.com/" -auth "user:token" -http \
  update-job "comfyui-nn-h200-136-141g-1" < config.xml && \
java -jar jenkins-cli.jar -s "https://jenkins.bytebroad.com/" -auth "user:token" -http \
  build "comfyui-nn-h200-136-141g-1"
```

## Related Files

- `.github/workflows/docker-acr.yml` - GitHub Actions workflow
- `jenkins-deploy/github-token-PAT.md` - GitHub credentials
- `jenkins-deploy/jenkins-accesstoken.md` - Jenkins credentials
- `Dockerfile` - Container image definition
- `docker-compose.yml` - Local development setup

---

*Generated from Run-ComfyUI-Ollama deployment workflow analysis*