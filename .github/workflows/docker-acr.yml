name: Build and Push Docker Image to ACR

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      image_version:
        description: "Docker image version tag, or use auto (default)"
        required: false
        default: auto
      opencode_version:
        description: "OpenCode version for build-arg OPENCODE_VERSION (default: Dockerfile ARG)"
        required: false
      opencode_manager_ref:
        description: "Git ref/tag for opencode-manager build-arg OPENCODE_MANAGER_REF (default: Dockerfile ARG)"
        required: false
      push_latest:
        description: "Also push latest tag"
        required: false
        type: boolean
        default: false
      custom_tags:
        description: "Comma-separated custom tags to apply (optional)"
        required: false

env:
  REGISTRY: registry.cn-shenzhen.aliyuncs.com
  MAIN_REPOSITORY: sailfish/runnode-llamacpp-glm47-opencode
  MAIN_IMAGE: registry.cn-shenzhen.aliyuncs.com/sailfish/runnode-llamacpp-glm47-opencode

jobs:
  docker-main:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Free disk space on runner
        shell: bash
        run: |
          set -eux
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/hostedtoolcache || true
          sudo rm -rf /usr/share/ghc || true
          sudo rm -rf /opt/conda || true
          docker system prune -af --volumes || true
          df -h

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Resolve image version
        id: version
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            IMAGE_VERSION_INPUT="${{ github.event.inputs.image_version }}"
            if [[ -z "${IMAGE_VERSION_INPUT}" || "${IMAGE_VERSION_INPUT}" == "auto" ]]; then
              VERSION="$(date +%Y%m%d)-${GITHUB_SHA::7}"
            else
              VERSION="${IMAGE_VERSION_INPUT}"
            fi
          elif [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Image version: ${VERSION}"

      - name: Resolve component versions for image tag
        id: component_versions
        shell: bash
        run: |
          DOCKERFILE_OPENCODE_VERSION="$(sed -n 's/^ARG OPENCODE_VERSION=\(.*\)$/\1/p' Dockerfile | head -n 1)"
          DOCKERFILE_OPENCODE_MANAGER_REF="$(sed -n 's/^ARG OPENCODE_MANAGER_REF=\(.*\)$/\1/p' Dockerfile | head -n 1)"

          OPENCODE_VERSION_INPUT="${{ github.event.inputs.opencode_version }}"
          OPENCODE_MANAGER_REF_INPUT="${{ github.event.inputs.opencode_manager_ref }}"

          OPENCODE_VERSION="${OPENCODE_VERSION_INPUT:-$DOCKERFILE_OPENCODE_VERSION}"
          OPENCODE_MANAGER_REF="${OPENCODE_MANAGER_REF_INPUT:-$DOCKERFILE_OPENCODE_MANAGER_REF}"

          OPENCODE_TAG_SAFE="${OPENCODE_VERSION//[^a-zA-Z0-9._-]/-}"
          MANAGER_TAG_SAFE="${OPENCODE_MANAGER_REF//[^a-zA-Z0-9._-]/-}"
          FULL_TAG="${{ steps.version.outputs.version }}-llamacpp-opencode-${OPENCODE_TAG_SAFE}-manager-${MANAGER_TAG_SAFE}"

          echo "opencode_version=${OPENCODE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "opencode_manager_ref=${OPENCODE_MANAGER_REF}" >> "$GITHUB_OUTPUT"
          echo "full_tag=${FULL_TAG}" >> "$GITHUB_OUTPUT"

          echo "OpenCode version: ${OPENCODE_VERSION}"
          echo "OpenCode Manager ref: ${OPENCODE_MANAGER_REF}"
          echo "Full image tag: ${FULL_TAG}"

      - name: Log in to Alibaba Cloud ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALICLOUD_REGISTRY_USERNAME }}
          password: ${{ secrets.ALICLOUD_REGISTRY_PASSWORD }}

      - name: Build and push main image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          build-args: |
            OPENCODE_VERSION=${{ steps.component_versions.outputs.opencode_version }}
            OPENCODE_MANAGER_REF=${{ steps.component_versions.outputs.opencode_manager_ref }}
          tags: |
            ${{ env.MAIN_IMAGE }}:${{ steps.component_versions.outputs.full_tag }}
          platforms: linux/amd64
          pull: true
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        shell: bash
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Tag and push latest
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.push_latest == 'true'
        shell: bash
        run: |
          docker buildx imagetools create \
            --tag "${MAIN_IMAGE}:latest" \
            "${MAIN_IMAGE}:${{ steps.component_versions.outputs.full_tag }}"
