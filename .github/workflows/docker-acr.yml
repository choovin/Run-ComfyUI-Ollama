name: Build and Push Docker Image to ACR

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      image_version:
        description: "Docker image version tag (for example: 20260213 or v1.0.0)"
        required: true
      comfyui_version:
        description: "ComfyUI runtime version used in Dockerfile (default: Dockerfile ARG COMFYUI_VERSION)"
        required: false
      ollama_version:
        description: "Ollama version for build-arg OLLAMA_VERSION (default: Dockerfile ARG OLLAMA_VERSION)"
        required: false
      sidecar_source_image:
        description: "Source image for GLM5 sidecar mirror (default: ghcr.io/ggml-org/llama.cpp:server-cuda)"
        required: false
      push_latest:
        description: "Also push latest tag"
        required: false
        type: boolean
        default: false

env:
  REGISTRY: registry.cn-shenzhen.aliyuncs.com
  MAIN_REPOSITORY: sailfish/runnode-run-comfyui-ollama
  MAIN_IMAGE: registry.cn-shenzhen.aliyuncs.com/sailfish/runnode-run-comfyui-ollama
  SIDECAR_REPOSITORY: sailfish/runnode-llamacpp-glm5
  SIDECAR_IMAGE: registry.cn-shenzhen.aliyuncs.com/sailfish/runnode-llamacpp-glm5
  DEFAULT_SIDECAR_SOURCE_IMAGE: ghcr.io/ggml-org/llama.cpp:server-cuda

jobs:
  docker-main:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Free disk space on runner
        shell: bash
        run: |
          set -eux
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/hostedtoolcache || true
          docker system prune -af || true
          df -h

      - name: Resolve image version
        id: version
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.image_version }}"
          elif [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Image version: ${VERSION}"

      - name: Resolve component versions for image tag
        id: component_versions
        shell: bash
        run: |
          DOCKERFILE_COMFYUI_VERSION="$(sed -n 's/^ARG COMFYUI_VERSION=\(.*\)$/\1/p' Dockerfile | head -n 1)"
          DOCKERFILE_OLLAMA_VERSION="$(sed -n 's/^ARG OLLAMA_VERSION=\(.*\)$/\1/p' Dockerfile | head -n 1)"

          COMFYUI_VERSION_INPUT="${{ github.event.inputs.comfyui_version }}"
          OLLAMA_VERSION_INPUT="${{ github.event.inputs.ollama_version }}"

          COMFYUI_VERSION="${COMFYUI_VERSION_INPUT:-$DOCKERFILE_COMFYUI_VERSION}"
          OLLAMA_VERSION="${OLLAMA_VERSION_INPUT:-$DOCKERFILE_OLLAMA_VERSION}"

          COMFYUI_TAG_SAFE="${COMFYUI_VERSION//[^a-zA-Z0-9._-]/-}"
          OLLAMA_TAG_SAFE="${OLLAMA_VERSION//[^a-zA-Z0-9._-]/-}"
          FULL_TAG="${{ steps.version.outputs.version }}-comfyui-${COMFYUI_TAG_SAFE}-ollama-${OLLAMA_TAG_SAFE}"

          echo "comfyui_version=${COMFYUI_VERSION}" >> "$GITHUB_OUTPUT"
          echo "ollama_version=${OLLAMA_VERSION}" >> "$GITHUB_OUTPUT"
          echo "full_tag=${FULL_TAG}" >> "$GITHUB_OUTPUT"

          echo "ComfyUI version: ${COMFYUI_VERSION}"
          echo "Ollama version: ${OLLAMA_VERSION}"
          echo "Full image tag: ${FULL_TAG}"

      - name: Log in to Alibaba Cloud ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALICLOUD_REGISTRY_USERNAME }}
          password: ${{ secrets.ALICLOUD_REGISTRY_PASSWORD }}

      - name: Build and push main image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          build-args: |
            COMFYUI_VERSION=${{ steps.component_versions.outputs.comfyui_version }}
            OLLAMA_VERSION=${{ steps.component_versions.outputs.ollama_version }}
          tags: |
            ${{ env.MAIN_IMAGE }}:${{ steps.component_versions.outputs.full_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Tag and push latest
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.push_latest == 'true'
        shell: bash
        run: |
          docker buildx imagetools create \
            --tag "${MAIN_IMAGE}:latest" \
            "${MAIN_IMAGE}:${{ steps.component_versions.outputs.full_tag }}"

  docker-sidecar-mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Resolve image version
        id: version
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.image_version }}"
          elif [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Image version: ${VERSION}"

      - name: Resolve sidecar source image and tag
        id: sidecar
        shell: bash
        run: |
          SIDECAR_SOURCE_INPUT="${{ github.event.inputs.sidecar_source_image }}"
          SIDECAR_SOURCE="${SIDECAR_SOURCE_INPUT:-${DEFAULT_SIDECAR_SOURCE_IMAGE}}"
          SIDECAR_TAG="${{ steps.version.outputs.version }}-llamacpp-official"

          echo "source=${SIDECAR_SOURCE}" >> "$GITHUB_OUTPUT"
          echo "tag=${SIDECAR_TAG}" >> "$GITHUB_OUTPUT"

          echo "Sidecar source image: ${SIDECAR_SOURCE}"
          echo "Sidecar target tag: ${SIDECAR_TAG}"

      - name: Log in to Alibaba Cloud ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALICLOUD_REGISTRY_USERNAME }}
          password: ${{ secrets.ALICLOUD_REGISTRY_PASSWORD }}

      - name: Mirror sidecar image to ACR
        shell: bash
        run: |
          docker buildx imagetools create \
            --tag "${SIDECAR_IMAGE}:${{ steps.sidecar.outputs.tag }}" \
            "${{ steps.sidecar.outputs.source }}"

      - name: Tag and push latest
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.push_latest == 'true'
        shell: bash
        run: |
          docker buildx imagetools create \
            --tag "${SIDECAR_IMAGE}:latest" \
            "${SIDECAR_IMAGE}:${{ steps.sidecar.outputs.tag }}"
