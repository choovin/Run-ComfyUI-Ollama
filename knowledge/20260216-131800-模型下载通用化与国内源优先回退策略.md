# 模型下载通用化与国内源优先回退策略

## 背景
- 频繁测试 `glm5` / `glm47flash` / `kimi2.5` / `minimax2.5` 不同量化版本时，若每次都改 `start.sh`，会触发重新构建镜像，迭代成本高。

## 目标
- 后续主要通过 Jenkins 环境变量改模型与下载地址，不再改启动脚本逻辑。
- 下载顺序固定为：`ModelScope -> HF 国内镜像 -> HuggingFace 官方`。

## 本次改动
1. `start.sh` 增加通用下载参数
- `MODEL_AUTO_DOWNLOAD`
- `MODEL_DOWNLOAD_URL`
- `MODEL_DOWNLOAD_URLS`（逗号分隔分片）
- `MODEL_DOWNLOAD_TOKEN`
- `MODEL_DOWNLOAD_FALLBACK_ENABLED`
- `MODELSCOPE_BASE`
- `HF_MIRROR_BASE`

2. 下载流程通用化
- 单文件模型：使用 `MODEL_DOWNLOAD_URL` 下载到 `LLAMACPP_MODEL_PATH`。
- 分片模型：使用 `MODEL_DOWNLOAD_URLS` 下载到模型目录，已存在分片自动跳过。

3. 国内源优先回退
- 对 `huggingface.co` 链接自动生成候选下载地址并按顺序尝试：
  1) `https://modelscope.cn/models/...`
  2) `https://hf-mirror.com/...`
  3) 原始 `https://huggingface.co/...`

4. 向后兼容
- 保留并兼容旧变量：
  - `AUTO_DOWNLOAD_GLM47FLASH` / `GLM47FLASH_DOWNLOAD_URL(_TOKEN)`
  - `AUTO_DOWNLOAD_MINIMAX25` / `MINIMAX25_DOWNLOAD_URL(S)(_TOKEN)`
- 若未设置通用变量，脚本会自动映射旧变量行为。

## 使用建议
- 新模型或新量化优先只改 Jenkins 配置：
  - `MODEL_PRESET`
  - `MODEL_PATH_*`
  - `MODEL_AUTO_DOWNLOAD`
  - `MODEL_DOWNLOAD_URL` 或 `MODEL_DOWNLOAD_URLS`
  - `MODEL_DOWNLOAD_TOKEN`（可复用 `HF_TOKEN`）
- 仅当需要新增下载策略时再改 `start.sh`。
