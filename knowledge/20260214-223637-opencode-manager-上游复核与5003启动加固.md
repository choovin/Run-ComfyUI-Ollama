# 20260214-223637 复核 opencode-manager 上游源码并加固5003完整服务启动

## 复核方式
- 由于当前环境策略阻止 `git clone`，改为直接抓取上游源码关键文件：
  - `package.json`
  - `backend/src/index.ts`
  - `shared/src/config/env.ts`
  - `Dockerfile`
  - `docker-compose.yml`

## 上游结论
1. `backend/src/index.ts` 明确分支：
- `NODE_ENV=production`：`serveStatic('./frontend/dist')`，`/` 返回前端页面。
- 非 production：`/` 返回 JSON 状态（正是线上当前现象）。

2. 上游容器默认就是：
- `NODE_ENV=production`
- 进程命令 `bun backend/src/index.ts`
- 健康检查 `/api/health`

3. 上游推荐 manager 单独使用 `OPENCODE_SERVER_PORT=5551` 作为内部 opencode 端口。

## 本次加固
- `start.sh`：
  - 支持 `OPENCODE_MANAGER_HOST/OPENCODE_MANAGER_PORT` 映射到 `HOST/PORT`。
  - 默认 `NODE_ENV=production`。
  - 检查 `frontend/dist`；缺失时自动尝试 `pnpm --filter frontend build`。
  - 就绪探针为 `/api/health`，并检测 `/` 是否 `text/html`。

## 结果
- 方案与上游行为一致：`5003` 可提供完整前后端。
- 若仍返回 JSON，优先排查运行时是否被覆盖为 `NODE_ENV!=production` 或 `frontend/dist` 不存在。
